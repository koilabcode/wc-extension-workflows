name: Check PHP Coding Standards

on:
  workflow_call:
    secrets:
      COMPOSER_AUTH:
        required: true

defaults:
  run:
    shell: bash

jobs:
  phpcs:
    name: Checking standards
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 100

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        env:
          runner: self-hosted
        with:
          php-version: 7.4
          tools: composer, cs2pr

      - name: Tool versions
        run: |
          node -v
          php --version
          composer --version

      - uses: koilabcode/wc-extension-workflows/.github/actions/install-composer-deps@main
        with:
          workflow_name: check-phpcs
          github_pat: ${{ secrets.COMPOSER_AUTH }}

      - name: Check current directory
        run: pwd

      - name: Download PHPCS script
        run: curl -o $PWD/bin/phpcs-in-changes.sh https://raw.githubusercontent.com/koilabcode/wc-extension-workflows/main/bin/phpcs-in-changes.sh

      - name: Give script permissions
        run: chmod +x $PWD/bin/phpcs-in-changes.sh

      - name: Sets env vars for Pull Request
        if: github.event_name == 'pull_request'
        run: |
          echo "FIRST_COMMIT_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV

      - name: Sets env vars for Push
        if: github.event_name == 'push'
        run: |
          echo "FIRST_COMMIT_SHA=${{ github.event.before }}" >> $GITHUB_ENV

      - name: Run PHP_CodeSniffer
        continue-on-error: true
        run: sh $PWD/bin/phpcs-in-changes.sh "${{ env.FIRST_COMMIT_SHA }}" "${{ github.event.after }}"

      - name: Show results
        run: cs2pr ./phpcs-report.xml
